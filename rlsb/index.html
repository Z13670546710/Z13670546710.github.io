<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR相机演示准备</title>
    <script src="./js/tf.min.js"></script>
    <script src="./js/ace-landmarks-detection.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2, #e4efe9);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #2c3e50;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .description {
            max-width: 800px;
            margin: 0 auto 20px;
            font-size: 1.1rem;
            line-height: 1.6;
            text-align: center;
            color: #5d6d7e;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            width: 100%;
            max-width: 1200px;
        }
        
        .video-container {
            position: relative;
            width: 640px;
            max-width: 100%;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.3);
        }
        
        #video {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1);
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform: scaleX(-1);
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            /* gap: 25px; */
            width: 320px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            color: #2c3e50;
            font-weight: 600;
        }
        
        button {
            background: linear-gradient(to right, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            background: rgba(236, 240, 241, 0.8);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-top: 15px;
            border: 1px solid rgba(189, 195, 199, 0.3);
        }
        
        .status p {
            color: #5d6d7e;
            font-weight: 500;
        }
        
        .instructions {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 10px;
        }
        
        .instruction-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
            border-left: 4px solid #3498db;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        
        .instruction-item:hover {
            transform: translateX(5px);
        }
        
        .instruction-item h3 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .instruction-item p {
            color: #5d6d7e;
            line-height: 1.5;
            font-size: 0.95rem;
        }
        
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            z-index: 10;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .loading p {
            color: #2c3e50;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            
            .controls {
                width: 100%;
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>AR相机演示准备</h1>
    </header>
    
    <div class="container">
        <div class="video-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
            <div id="loading" class="loading">
                <p>正在初始化模型和摄像头...</p>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h2>控制面板</h2>
                <button id="startButton">启动摄像头</button>
                <button id="stopButton" disabled style="display: none;">停止摄像头</button>
                <div class="status" style="display: none;">
                    <p id="statusText">点击"启动摄像头"开始</p>
                </div>
            </div>
            
            <div class="instructions">
                <div class="instruction-item">
                    <h3>1. 打开AR相机应用</h3>
                    <p>老师会在大屏幕显示</p>
                </div>
                
                <div class="instruction-item">
                    <h3>2. 请一个小朋友到镜头前</h3>
                    <p>大家一起观察屏幕上的变化</p>
                </div>
                
                <div class="instruction-item">
                    <h3>3. 看看脸上出现的点点和框框</h3>
                    <p>这就是AI正在测量的特征点！</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 获取DOM元素
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusText = document.getElementById('statusText');
        const loading = document.getElementById('loading');

        let model = null;
        let isDetecting = false;
        let animationId = null;
        let lastFrameTime = 0;
        let frameTimes = [];
        
        // 初始化摄像头
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480, 
                        facingMode: "user" 
                    } 
                });
                video.srcObject = stream;
                
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        // 设置canvas尺寸与视频一致
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        resolve(video);
                    };
                });
            } catch (error) {
                console.error("摄像头访问错误:", error);
                statusText.textContent = "无法访问摄像头，请检查权限设置";
                throw error;
            }
        }

        // 加载模型
        async function loadModel() {
            try {
                loading.style.display = 'block';
                statusText.textContent = "正在加载人脸识别模型...";
                
                // 加载人脸关键点检测模型
                model = await faceLandmarksDetection.load(
                    faceLandmarksDetection.SupportedPackages.mediapipeFacemesh,
                    { maxFaces: 1 }
                );
                
                loading.style.display = 'none';
                statusText.textContent = "模型加载完成，准备开始检测";
                
                return model;
            } catch (error) {
                console.error("模型加载错误:", error);
                statusText.textContent = "模型加载失败: " + error.message;
                loading.style.display = 'none';
                throw error;
            }
        }

        // 绘制面部关键点
        function drawFaceLandmarks(predictions) {
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (predictions.length > 0) {
                // 为每个检测到的人脸绘制关键点
                predictions.forEach(prediction => {
                    const keypoints = prediction.scaledMesh;
                    
                    // 绘制外部轮廓点圈
                    drawFaceOutline(keypoints);
                    
                    // 绘制面部轮廓
                    drawFaceContour(keypoints);
                    
                    // 绘制左眼
                    drawLeftEye(keypoints);
                    
                    // 绘制右眼
                    drawRightEye(keypoints);
                    
                    // 绘制鼻子
                    drawNose(keypoints);
                    
                    // 绘制嘴唇
                    drawLips(keypoints);
                    
                    // 绘制眉毛
                    drawEyebrows(keypoints);
                });
            }
        }

        // 绘制人脸外部轮廓点圈
        function drawFaceOutline(keypoints) {
            const faceOutlinePoints = [
                10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 
                361, 288, 397, 365, 379, 378, 400, 377, 152, 148, 
                176, 149, 150, 136, 172, 58, 132, 93, 234, 127, 
                162, 21, 54, 103, 67, 109
            ];
            
            ctx.beginPath();
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 3;
            
            const firstPoint = keypoints[faceOutlinePoints[0]];
            ctx.moveTo(firstPoint[0], firstPoint[1]);
            
            for (let i = 1; i < faceOutlinePoints.length; i++) {
                const point = keypoints[faceOutlinePoints[i]];
                ctx.lineTo(point[0], point[1]);
            }
            
            ctx.closePath();
            ctx.stroke();
            
            faceOutlinePoints.forEach(index => {
                const point = keypoints[index];
                ctx.beginPath();
                ctx.arc(point[0], point[1], 3, 0, 2 * Math.PI);
                ctx.fillStyle = '#FFD700';
                ctx.fill();
            });
        }

        // 绘制面部轮廓
        function drawFaceContour(keypoints) {
            const contourPoints = keypoints.slice(0, 17);
            
            ctx.beginPath();
            ctx.strokeStyle = '#00f2fe';
            ctx.lineWidth = 2;
            
            ctx.moveTo(contourPoints[0][0], contourPoints[0][1]);
            for (let i = 1; i < contourPoints.length; i++) {
                ctx.lineTo(contourPoints[i][0], contourPoints[i][1]);
            }
            ctx.stroke();
            
            contourPoints.forEach(point => {
                ctx.beginPath();
                ctx.arc(point[0], point[1], 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#00f2fe';
                ctx.fill();
            });
        }

        // 绘制左眼
        function drawLeftEye(keypoints) {
            const leftEyePoints = [
                7, 163, 144, 145, 153, 154, 155, 133, 
                246, 161, 160, 159, 158, 157, 173
            ].map(index => keypoints[index]);
            
            ctx.beginPath();
            ctx.strokeStyle = '#ff4081';
            ctx.lineWidth = 2;
            
            ctx.moveTo(leftEyePoints[0][0], leftEyePoints[0][1]);
            for (let i = 1; i < leftEyePoints.length; i++) {
                ctx.lineTo(leftEyePoints[i][0], leftEyePoints[i][1]);
            }
            ctx.closePath();
            ctx.stroke();
            
            leftEyePoints.forEach(point => {
                ctx.beginPath();
                ctx.arc(point[0], point[1], 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#ff4081';
                ctx.fill();
            });
        }

        // 绘制右眼
        function drawRightEye(keypoints) {
            const rightEyePoints = [
                362, 382, 381, 380, 374, 373, 390, 249, 263, 
                466, 388, 387, 386, 385, 384, 398
            ].map(index => keypoints[index]);
            
            ctx.beginPath();
            ctx.strokeStyle = '#ff4081';
            ctx.lineWidth = 2;
            
            ctx.moveTo(rightEyePoints[0][0], rightEyePoints[0][1]);
            for (let i = 1; i < rightEyePoints.length; i++) {
                ctx.lineTo(rightEyePoints[i][0], rightEyePoints[i][1]);
            }
            ctx.closePath();
            ctx.stroke();
            
            rightEyePoints.forEach(point => {
                ctx.beginPath();
                ctx.arc(point[0], point[1], 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#ff4081';
                ctx.fill();
            });
        }

        // 绘制鼻子
        function drawNose(keypoints) {
            const nosePoints = [
                keypoints[1], keypoints[2], keypoints[3], 
                keypoints[4], keypoints[5], keypoints[6], 
                keypoints[168], keypoints[197], keypoints[195], keypoints[5]
            ];
            
            ctx.beginPath();
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 2;
            
            ctx.moveTo(nosePoints[0][0], nosePoints[0][1]);
            for (let i = 1; i < nosePoints.length; i++) {
                ctx.lineTo(nosePoints[i][0], nosePoints[i][1]);
            }
            ctx.stroke();
            
            nosePoints.forEach(point => {
                ctx.beginPath();
                ctx.arc(point[0], point[1], 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#4CAF50';
                ctx.fill();
            });
        }

        // 绘制嘴唇
        function drawLips(keypoints) {
            const outerLipsPoints = [
                keypoints[61], keypoints[146], keypoints[91], 
                keypoints[181], keypoints[84], keypoints[17], 
                keypoints[314], keypoints[405], keypoints[320], 
                keypoints[307], keypoints[375], keypoints[291], keypoints[61]
            ];
            
            const innerLipsPoints = [
                keypoints[78], keypoints[95], keypoints[88], 
                keypoints[178], keypoints[87], keypoints[14], 
                keypoints[317], keypoints[402], keypoints[318], 
                keypoints[324], keypoints[308], keypoints[78]
            ];
            
            // 绘制外嘴唇
            ctx.beginPath();
            ctx.strokeStyle = '#FF5722';
            ctx.lineWidth = 2;
            ctx.moveTo(outerLipsPoints[0][0], outerLipsPoints[0][1]);
            for (let i = 1; i < outerLipsPoints.length; i++) {
                ctx.lineTo(outerLipsPoints[i][0], outerLipsPoints[i][1]);
            }
            ctx.stroke();
            
            // 绘制内嘴唇
            ctx.beginPath();
            ctx.strokeStyle = '#FF5722';
            ctx.lineWidth = 2;
            ctx.moveTo(innerLipsPoints[0][0], innerLipsPoints[0][1]);
            for (let i = 1; i < innerLipsPoints.length; i++) {
                ctx.lineTo(innerLipsPoints[i][0], innerLipsPoints[i][1]);
            }
            ctx.stroke();
            
            // 绘制嘴唇点
            outerLipsPoints.forEach(point => {
                ctx.beginPath();
                ctx.arc(point[0], point[1], 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#FF5722';
                ctx.fill();
            });
        }

        // 绘制眉毛
        function drawEyebrows(keypoints) {
            const leftEyebrowPoints = [
                keypoints[276], keypoints[283], keypoints[282], 
                keypoints[295], keypoints[285]
            ];
            
            const rightEyebrowPoints = [
                keypoints[46], keypoints[53], keypoints[52], 
                keypoints[65], keypoints[55]
            ];
            
            // 绘制左眉
            ctx.beginPath();
            ctx.strokeStyle = '#9C27B0';
            ctx.lineWidth = 2;
            ctx.moveTo(leftEyebrowPoints[0][0], leftEyebrowPoints[0][1]);
            for (let i = 1; i < leftEyebrowPoints.length; i++) {
                ctx.lineTo(leftEyebrowPoints[i][0], leftEyebrowPoints[i][1]);
            }
            ctx.stroke();
            
            // 绘制右眉
            ctx.beginPath();
            ctx.strokeStyle = '#9C27B0';
            ctx.lineWidth = 2;
            ctx.moveTo(rightEyebrowPoints[0][0], rightEyebrowPoints[0][1]);
            for (let i = 1; i < rightEyebrowPoints.length; i++) {
                ctx.lineTo(rightEyebrowPoints[i][0], rightEyebrowPoints[i][1]);
            }
            ctx.stroke();
            
            // 绘制眉毛点
            leftEyebrowPoints.forEach(point => {
                ctx.beginPath();
                ctx.arc(point[0], point[1], 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#9C27B0';
                ctx.fill();
            });
            
            rightEyebrowPoints.forEach(point => {
                ctx.beginPath();
                ctx.arc(point[0], point[1], 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#9C27B0';
                ctx.fill();
            });
        }

        // 人脸检测循环
        async function detectFaces() {
            if (!isDetecting) return;
            
            const startTime = performance.now();
            
            try {
                // 进行人脸检测
                const predictions = await model.estimateFaces({
                    input: video
                });
                
                // 绘制检测结果
                drawFaceLandmarks(predictions);
                
                // 计算FPS
                const now = performance.now();
                const delta = now - lastFrameTime;
                
                if (lastFrameTime > 0) {
                    frameTimes.push(delta);
                    if (frameTimes.length > 10) frameTimes.shift();
                }
                lastFrameTime = now;
                
            } catch (error) {
                console.error("人脸检测错误:", error);
            }
            
            // 继续下一帧检测
            if (isDetecting) {
                requestAnimationFrame(detectFaces);
            }
        }

        // 开始检测
        async function startDetection() {
            try {
                startButton.disabled = true;
                loading.style.display = 'block';
                statusText.textContent = "正在启动摄像头...";
                
                await setupCamera();
                
                loading.style.display = 'none';
                statusText.textContent = "正在初始化人脸检测...";
                
                // 加载模型
                await loadModel();
                
                isDetecting = true;
                stopButton.disabled = false;
                statusText.textContent = "检测已启动，正在实时识别人脸";
                
                // 开始人脸检测循环
                detectFaces();
                
            } catch (error) {
                console.error("启动检测失败:", error);
                statusText.textContent = "启动失败: " + error.message;
                startButton.disabled = false;
                loading.style.display = 'none';
            }
        }

        // 停止检测
        function stopDetection() {
            isDetecting = false;
            
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 停止视频流
            const stream = video.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
            
            // 更新UI
            startButton.disabled = false;
            stopButton.disabled = true;
            statusText.textContent = "检测已停止";
        }

        // 事件监听
        startButton.addEventListener('click', startDetection);
        stopButton.addEventListener('click', stopDetection);
    </script>
</body>
</html>